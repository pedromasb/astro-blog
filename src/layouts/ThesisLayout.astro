---
import { SITE } from "@config";
import Footer from "@components/Footer.astro";
import Header from "@components/Header.astro";
import Layout from "./Layout.astro";

export interface Props {
  title?: string;
  description?: string;
  frontmatter?: {
    title: string;
    description?: string;
  };
}

const { title, description, frontmatter } = Astro.props;
const pageTitle = (title ?? frontmatter?.title ?? "Doctoral Thesis");
const pageDesc  = (description ?? frontmatter?.description ?? "PhD thesis — details and abstract");
---

<Layout title={`${pageTitle} | ${SITE.title}`} description={pageDesc}>
  <Header activeNav="thesis" />

  <main id="main-content" class="mx-auto max-w-3xl px-4 pb-12">
    <!-- Match site-wide title style -->
    <h1 class="text-3xl mt-5 mb-8 font-semibold">{pageTitle}</h1>

    <!-- Meta (transparent "card": only border) -->
    <section class="rounded-2xl border border-skin-line/40 shadow-none mb-8">
      <div class="p-5 sm:p-6">
        <slot name="meta" />
      </div>
    </section>

    <!-- PDF Access Section -->
    <section class="rounded-2xl border border-skin-line/40 shadow-none mb-8">
      <div class="p-5 sm:p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl sm:text-2xl font-semibold">Full Thesis</h2>
          <div class="flex gap-2">
            <button 
              id="pdf-viewer-toggle"
              class="flex items-center gap-1.5 px-3 py-1.5 text-sm rounded-lg border border-skin-line 
                     transition-all duration-200 transform hover:bg-gray-200/40 dark:hover:bg-gray-700/40 hover:scale-105"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
              </svg>
              <span class="viewer-toggle-text">Read Online</span>
            </button>
            <a 
              href="/thesis.pdf" 
              download="Mas-Buitrago_PhD_Thesis.pdf"
              class="flex items-center gap-1.5 px-3 py-1.5 text-sm rounded-lg bg-skin-accent text-skin-inverted
                     transition-all duration-200 transform hover:opacity-90 hover:scale-105"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
              </svg>
              <span>Download PDF</span>
            </a>
          </div>
        </div>
        
        <!-- Quick access links to specific sections -->
        <div class="flex flex-wrap gap-2 mb-4">
          <span class="text-sm text-skin-muted">Quick access:</span>
          <a href="/thesis.pdf#page=9" target="_blank" 
             class="px-2 py-0.5 text-xs rounded-full border border-skin-line/60 
                    hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
            Abstract
          </a>
          <a href="/thesis.pdf#page=11" target="_blank" 
             class="px-2 py-0.5 text-xs rounded-full border border-skin-line/60 
                    hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
            Introduction
          </a>
          <a href="/thesis.pdf#page=31" target="_blank" 
             class="px-2 py-0.5 text-xs rounded-full border border-skin-line/60 
                    hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
            Ultracool Dwarfs in J-PLUS
          </a>
          <a href="/thesis.pdf#page=57" target="_blank" 
             class="px-2 py-0.5 text-xs rounded-full border border-skin-line/60 
                    hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
            Flaring M dwarfs
          </a>
          <a href="/thesis.pdf#page=57" target="_blank" 
             class="px-2 py-0.5 text-xs rounded-full border border-skin-line/60 
                    hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
            DTL for M Dwarfs
          </a>
          <a href="/thesis.pdf#page=93" target="_blank" 
             class="px-2 py-0.5 text-xs rounded-full border border-skin-line/60 
                    hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
            DTL for Ultracool Dwarfs
          </a>
          <a href="/thesis.pdf#page=101" target="_blank" 
             class="px-2 py-0.5 text-xs rounded-full border border-skin-line/60 
                    hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
            Conclusions and Future Work
          </a>
        </div>
        
        <!-- Hidden PDF viewer that expands when "Read Online" is clicked -->
        <div id="pdf-viewer-container" class="hidden">
          <div class="relative">
            <iframe 
              id="thesis-pdf-frame"
              src="/thesis.pdf#view=FitH&toolbar=1" 
              class="w-full h-[600px] rounded-lg border border-skin-line mt-4"
              title="PhD Thesis PDF Viewer"
            >
            </iframe>
            <!-- Loading indicator -->
            <div id="pdf-loading" class="absolute inset-0 flex items-center justify-center bg-skin-fill/50 rounded-lg mt-4">
              <div class="text-skin-muted">Loading PDF...</div>
            </div>
          </div>
          <p class="text-xs text-skin-muted mt-2">
            Tip: Use your browser's zoom controls or the PDF toolbar for better reading experience.
          </p>
        </div>
      </div>
      
      <script>
        // Handle PDF viewer toggle
        const pdfToggleBtn = document.getElementById('pdf-viewer-toggle');
        const pdfContainer = document.getElementById('pdf-viewer-container');
        const pdfFrame = document.getElementById('thesis-pdf-frame');
        const pdfLoading = document.getElementById('pdf-loading');
        const toggleText = pdfToggleBtn?.querySelector('.viewer-toggle-text');
        
        if (pdfToggleBtn && pdfContainer) {
          let pdfLoaded = false;
          
          pdfToggleBtn.addEventListener('click', () => {
            const isHidden = pdfContainer.classList.contains('hidden');
            
            if (isHidden) {
              // Show the viewer
              pdfContainer.classList.remove('hidden');
              toggleText.textContent = 'Hide Viewer';
              
              // Load PDF if not already loaded
              if (!pdfLoaded && pdfFrame) {
                pdfFrame.addEventListener('load', () => {
                  pdfLoading?.classList.add('hidden');
                  pdfLoaded = true;
                }, { once: true });
              } else {
                pdfLoading?.classList.add('hidden');
              }
            } else {
              // Hide the viewer
              pdfContainer.classList.add('hidden');
              toggleText.textContent = 'Read Online';
            }
          });
        }
      </script>
    </section>

    <section class="thesis-chat mb-10 max-w-2xl mx-auto">
      <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-center">
        Talk with my thesis
      </h2>

      <!-- Chat form -->
      <form id="thesis-form" class="flex gap-2 items-center">
        <input
          type="text"
          id="thesis-query"
          name="query"
          placeholder="Ask about J-PLUS, CARMENES, UCDs…"
          class="flex-1 rounded-lg border border-skin-line px-3 py-2
                text-sm sm:text-base focus:outline-none focus:border-gray-400
                bg-transparent placeholder:text-gray-500 dark:placeholder:text-gray-400"
        />
        <button
          type="submit"
          class="rounded-lg border border-skin-line px-4 py-2
                text-sm sm:text-base font-medium transition-all duration-200 transform
                hover:bg-gray-200/40 dark:hover:bg-gray-700/40 hover:scale-105"
        >
          Ask
        </button>
      </form>

      <!-- Answer container -->
      <div id="thesis-answer" class="mt-6 text-base leading-relaxed"></div>

      <script type="module">
        import { marked } from "https://cdn.jsdelivr.net/npm/marked@12.0.2/lib/marked.esm.js";
        const form = document.getElementById("thesis-form");
        const input = document.getElementById("thesis-query");
        const answerBox = document.getElementById("thesis-answer");

        function asPath(md = {}) {
          const parts = [];
          if (md.chapter_key || md.chapter) parts.push(`Ch.${md.chapter_key ?? ""}: ${md.chapter ?? ""}`.trim());
          if (md.section_key || md.section) parts.push(`S.${md.section_key ?? ""}: ${md.section ?? ""}`.trim());
          if (md.subsection_key || md.subsection) parts.push(`SS.${md.subsection_key ?? ""}: ${md.subsection ?? ""}`.trim());
          return parts.filter(p => p && !p.endsWith(":")).join(" | ");
        }

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const query = input.value.trim();
          if (!query) return;

          // reset UI
          answerBox.innerHTML = `<div class="text-skin-muted">Thinking…</div>`;

          try {
            const resp = await fetch("/api/ask", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ query }),
            });
            const data = await resp.json();

            if (!resp.ok) {
              throw new Error(data.error || resp.statusText);
            }

            // Render answer (Markdown → HTML)
            const rawAnswer = data.answer || "No answer.";
            const answerHtml = marked.parse(rawAnswer);

            // Render sources as numbered list
            const sources = Array.isArray(data.sources) ? data.sources : [];
            const listItems = sources.map((s, i) => {
              const label = s.path || asPath(s.meta ?? s.metadata ?? {}) || "(no path)";
              const snippet = s.preview ? `<div class="text-skin-muted italic">${s.preview}</div>` : "";
              return `<li class="mb-2">[${i + 1}] ${label}${snippet}</li>`;
            }).join("");

            const sourcesHtml = sources.length
              ? `<div class="mt-4">
                  <div class="text-sm font-semibold mb-1">Sources</div>
                  <ol class="list-decimal pl-5 text-sm leading-relaxed">${listItems}</ol>
                </div>`
              : "";

            answerBox.innerHTML = `<div class="prose prose-neutral dark:prose-invert">${answerHtml}</div>${sourcesHtml}`;
          } catch (err) {
            answerBox.innerHTML = `<div class="text-red-600 text-sm">Error: ${err.message}</div>`;
          }
        });
      </script>
    </section>

    <!-- Optional extra content below -->
    <section class="prose prose-neutral dark:prose-invert max-w-none mt-10">
      <slot />
    </section>
  </main>

  <Footer />
</Layout>

<style>
  /* Make ThesisAsk look like a chat box without changing its JSX */
  .thesis-chat {
    /* no background; border already on parent section */
  }

  /* Normalize headings inside LLM output */
  .thesis-chat .prose h3,
  .thesis-chat .prose h4 {
    @apply mt-3 mb-2;
  }

  /* Input + button inside ThesisAsk → "chat bar" vibe */
  .thesis-chat input[type="text"],
  .thesis-chat input:not([type]),
  .thesis-chat textarea {
    @apply w-full rounded-xl border border-skin-line/60 bg-transparent
           px-3 py-2 outline-none
           focus-visible:ring-1 focus-visible:ring-gray-400 dark:focus-visible:ring-gray-600;
  }

  .thesis-chat button {
    @apply rounded-xl border border-skin-line/60 bg-transparent
           px-4 py-2 transition-all duration-200 transform
           hover:bg-gray-200/40 dark:hover:bg-gray-700/40 hover:scale-105;
  }

  /* Typical layout for an input row (if ThesisAsk uses a flex row) */
  .thesis-chat .flex.gap-2,
  .thesis-chat .flex.gap-3 {
    @apply items-center;
  }

  /* If ThesisAsk prints "Answer" and "Sources", space them nicely */
  .thesis-chat h3,
  .thesis-chat h4 {
    @apply text-base font-semibold;
  }
  .thesis-chat ol {
    @apply list-decimal pl-5;
  }

  .thesis-chat ol li div {
    font-size: 0.875rem; /* small */
    line-height: 1.4;
  }

  /* Rotate animation for toggle icon */
  .toggle-icon {
    transition: transform 0.2s ease-in-out;
  }
  
  .toggle-icon.rotate-180 {
    transform: rotate(180deg);
  }

  /* Abstract content - no CSS transitions needed, using Web Animations API */
  .abstract-content {
    position: relative;
  }

  /* Scrollbar for abstract (only where supported) */
  @supports selector(::-webkit-scrollbar) {
    .abstract-content[aria-expanded="true"] [role="region"]::-webkit-scrollbar,
    .abstract-inner::-webkit-scrollbar { 
      width: 8px; 
    }
    .abstract-content[aria-expanded="true"] [role="region"]::-webkit-scrollbar-thumb,
    .abstract-inner::-webkit-scrollbar-thumb {
      background: color-mix(in oklab, currentColor 20%, transparent);
      border-radius: 8px;
    }
  }
</style>