---
import { toBibTeX } from "../utils/cite";

const {
  title,
  pubDate,
  authors = [],
  journal,
  volume,
  pages,
  doi,
  arxiv,
  url,
  bibtexOverride,
} = Astro.props;

const year = pubDate ? new Date(pubDate).getFullYear() : undefined;

const bib = bibtexOverride ?? toBibTeX({
  title, authors, year, journal, volume, pages, doi, arxiv, url
});
---

<section class="mt-5 rounded-md border p-4 border-gray-600 dark:border-gray-100">
  <h3 class="text-base m-1 p-1 font-semibold">Cite this work</h3>

  <div class="text-sm mt-1 text-gray-700 dark:text-gray-300">
    {authors?.map((a:any)=>a.name).join(", ")} et al. ({year}). 
    <em>{title}</em>
    {journal ? `. ${journal}` : ""}
    {volume ? `, ${volume}` : ""}
    {pages ? `:${pages}` : ""}
    {doi ? `. doi:${doi}` : ""}
    {arxiv ? `. arXiv:${arxiv}` : ""}.
  </div>

  <div class="mt-3 flex gap-2">
    {doi && <a class="rounded border px-3 py-1" href={`https://doi.org/${doi}`} rel="noopener" target="_blank">DOI</a>}
    {arxiv && <a class="rounded border px-3 py-1" href={`https://arxiv.org/abs/${arxiv}`} rel="noopener" target="_blank">arXiv</a>}
    
    <!-- Copy BibTeX with tooltip -->
    <button type="button" class="copy-bib-btn rounded border px-3 py-1 text-sm relative group">
      Copy BibTeX
      <span class="tooltip-text absolute left-1/2 -translate-x-1/2 top-full mt-1 px-2 py-1 text-xs rounded bg-gray-800 text-white opacity-0 group-hover:opacity-100 transition-opacity duration-200">
        Copy citation in BibTeX format
      </span>
    </button>
  </div>

  <!-- Hidden BibTeX for copy -->
  <pre id="hidden-bib" class="hidden"><code>{bib}</code></pre>
</section>

<script is:inline>
  document.querySelectorAll('.copy-bib-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const code = document.querySelector('#hidden-bib code')?.innerText;
      if (!code) return;
      try {
        await navigator.clipboard.writeText(code);
        btn.firstChild.textContent = 'Copied!';
        setTimeout(() => (btn.firstChild.textContent = 'Copy BibTeX'), 3000);
      } catch (err) {
        console.error('Copy failed', err);
      }
    });
  });
</script>

<style>
  .hidden { display: none; }
  .tooltip-text {
    white-space: nowrap;
    pointer-events: none;
    z-index: 10;
  }
  
  /* Match DOI/arXiv button styles */
  .copy-bib-btn {
    border-color: var(--color-border);
    background-color: transparent;
    color: var(--color-text-base);
    transition: background-color 0.2s, color 0.2s;
  }
  .copy-bib-btn:hover {
    background-color: rgba(var(--color-border), 0.1);
  }
</style>
